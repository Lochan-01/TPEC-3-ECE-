#include <reg52.h>      // 8051 header
#include <string.h>     // for string functions
#include <stdio.h>      // for sprintf
#include <math.h>       // for sin()

#define LCD_PORT P2     // LCD data port

// Define LCD control pins
sbit LCD_RS = P3^0;     
sbit LCD_RW = P3^1;     
sbit LCD_EN = P3^2;     

// Function prototypes
void lcdinit(void);
void lcdcmd(unsigned char);
void lcddata(unsigned char);
void delay(unsigned int);
void lcdwrite(unsigned char *);

// ---- Main ----
void main() {
    char buffer[16];   // buffer for strings
    float rad, sine_val;
    int theta;

    lcdinit();  

    while (1) {
        for (theta = 0; theta <= 360; theta++) {
            rad = theta * 3.14159 / 180.0;    // degree ? radian
            sine_val = sin(rad);              // calculate sin(?)

            // Line 1 ? "Sin( xxx deg)"
            lcdcmd(0x80);   // first line start
            sprintf(buffer, "Sin(%3d deg)", theta);
            lcdwrite(buffer);

            // Line 2 ? sine value
            lcdcmd(0xC0);   // second line start
            sprintf(buffer, "%.4f", sine_val);
            lcdwrite(buffer);

            delay(800);   // wait before next update
            lcdcmd(0x01); // clear LCD
        }
    }
}

// ---- LCD Functions ----
void lcdinit(void) {
    lcdcmd(0x38);  // 8-bit, 2 lines, 5x7 font
    delay(2);
    lcdcmd(0x01);  // clear display
    delay(2);
    lcdcmd(0x0C);  // display ON, cursor OFF
    delay(2);
    lcdcmd(0x06);  // entry mode
    delay(2);
}

void lcdcmd(unsigned char value) {
    LCD_PORT = value;
    LCD_RS = 0;
    LCD_RW = 0;
    LCD_EN = 1;
    LCD_EN = 0;
    delay(2);
}

void lcddata(unsigned char value) {
    LCD_PORT = value;
    LCD_RS = 1;
    LCD_RW = 0;
    LCD_EN = 1;
    LCD_EN = 0;
    delay(2);
}

void lcdwrite(unsigned char *s) {
    while (*s) {
        lcddata(*s++);
    }
}

void delay(unsigned int ms) {
    unsigned int i, j;
    for (i = 0; i < ms; i++)
        for (j = 0; j < 1275; j++);
}
